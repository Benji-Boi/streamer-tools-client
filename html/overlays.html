<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Overlays - Streamer tools client</title>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <link href="standard.css" type="text/css" rel="stylesheet">
    </head>
    <body>
        <div style="display: flex;">
            <div class="sidebar" style="flex: 0;">
                <div class="sidebarItem" href="#" onclick='fetch("http://localhost:501/windows/home")'>
                    Home
                </div>
                <div class="sidebarItemSelected" onclick='fetch("http://localhost:501/windows/overlays")'>
                    Overlays
                </div>
                <div class="sidebarItem" onclick='fetch("http://localhost:501/windows/downloads")'>
                    Downloads
                </div>
            </div>
            <div class="content" style="flex: 1;">
                <div style="text-align: center; font-size: 24px; margin-bottom: 10px;">
                    Streamer Tools Client - Overlays
                </div>
                <div style="text-align: center; font-size: 18px;">
                    <div style="text-align: left; font-size: 14px; margin-left: 10px; margin-bottom: 20px;">Copy those URLs into a Browser widget in OBS to add them</div>
                    <div style="font-size: 22px;">Config:</div>
                    <table style="padding: 10px; width: 400px; text-align: center;">
                        
                        <tr><td>IP</td><td><input style="margin-top: 20px;" type='text' id="ip" onchange="UpdateAll()"></td></tr>
                        <tr><td>Update Rate in ms</td><td><input style="margin-top: 20px;" type='text' id="rate" value="100" onchange="UpdateAll()"></td>
                        <tr><td>Decimal places for Percentage</td><td><input style="margin-top: 20px;" type='text' id="decimals" value="2" onchange="UpdateAll()"></td>
                        <tr><td>Custom Text</td><td><input style="margin-top: 20px;" type='text' id="custom" value="" onchange="UpdateAll()"></td>
                        <tr><td>Don't show energy bar</td><td><input type="checkbox" id="dontenergy" onchange="UpdateAll()"></td>
                        <tr><td>Don't show mp code if shown in game</td><td><input type="checkbox" id="dontmpcode" onchange="UpdateAll()"></td>
                        <tr><td>Always show mp code if shown in game</td><td><input type="checkbox" id="alwaysmpcode" onchange="UpdateAll()"></td>
                    </table>
                    <div style="margin-top: 20px;">
                        <div style="font-size: 22px;">Overlays:</div>
                        <br/>
                        <div id="overlays">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </body>
    <script>
        var ipReg = /^((2(5[0-5]|[0-4][0-9])|1?[0-9]?[0-9])\.){3}(2(5[0-5]|[0-4][0-9])|1?[0-9]?[0-9])$/g
        fetch("http://localhost:501/api/getip").then((res) => {
            res.json().then((json) => {
                if(json.ip != null && json.ip != "null") document.getElementById("ip").value = json.ip
                fetch("http://localhost:501/api/getinterval").then((res2) => {
                    res2.json().then((json2) => {
                        document.getElementById("rate").value = json2.interval
                        UpdateAll();
                    });
                })
            });
        })
        function UpdateAll() {
            fetch("http://localhost:501/api/overlays").then((res) => {
                res.json().then((json) => {
                    document.getElementById("overlays").innerHTML = ""
                    json.forEach(overlay => {
                        if(overlay.downloaded) document.getElementById("overlays").innerHTML += FormatToHTML(overlay)
                    })
                    if(document.getElementById("overlays").innerHTML == "") document.getElementById("overlays").innerHTML = "Please download overlays"
                });
            })
        }

        document.getElementById('rate').onchange = function() {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "http://localhost:501/api/postinterval", true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                "interval": document.getElementById("rate").value
            }));
        }

        function constuctParameters() {
            return "&ip=" + document.getElementById("ip").value + "&updaterate=" + document.getElementById("rate").value + "&decimals=" + document.getElementById("decimals").value + (document.getElementById("dontenergy").checked ? "&dontshowenergy" : "") + (document.getElementById("dontmpcode").checked ? "&dontshowmpcode" : "") + (document.getElementById("alwaysmpcode").checked ? "&alwaysshowmpcode" : "") + (document.getElementById("custom").value != "" ? "&customtext=" + document.getElementById("custom").value : "") + "&nosetip"
        }

        function FormatToHTML(overlay) {
            var link = getLink(overlay.Name)
            return `<div style="margin-top: 20px;">${overlay.Name}:<br/><div style="font-size: 14px;">URL: <a style="font-size: 14px;" target="_blank" href="${link}">${link}</a><br/><input type='button' onclick='Copy("${link}")' style="margin-bottom: 5px;" value="Copy URL"><br/><iframe width=90% height="500px" src="${link}"></iframe></div></div>`
        }

        function getLink(overlayname) {
            return `http://localhost:501/api/getOverlay?name=${overlayname}` + constuctParameters()
        }

        function Copy(text) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "http://localhost:501/api/copytoclipboard", true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                "text": text
            }));
            alert("copied")
        }
    </script>
</html>